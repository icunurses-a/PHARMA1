<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Integrated Pathophysiology & Pharmacology</title>
<style>
    :root {
        --primary: #00d4ff;
        --secondary: #0055ff;
        --success: #00ff88;
        --danger: #ff0055;
        --dark: #0a0a12;
        --glass: rgba(20, 20, 35, 0.7);
        --text: #e0e6ed;
        --laser-color: #ff0000;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    
    body {
        margin: 0;
        background-color: var(--dark);
        color: var(--text);
        overflow: hidden; /* Prevent scroll on body, handle in app-container */
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        touch-action: none; /* Important for laser pen on mobile */
    }

    /* Background Canvases */
    #ecg-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.3;
    }
    #confetti {
        position: fixed; top: 0; left: 0; pointer-events: none; z-index: 100;
    }
    
    /* LASER PEN CANVAS */
    #laser-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999; /* On top of everything */
        pointer-events: none; /* Allows clicking through the laser */
        display: none; /* Hidden by default */
    }
    body.laser-active #laser-canvas {
        display: block;
    }

    /* RGB Shaking Title */
    @keyframes rgbShake {
        0% { color: #ff0000; transform: translate(0, 0) rotate(0deg); text-shadow: 2px 2px 10px rgba(255,0,0,0.5); }
        25% { color: #00ff00; transform: translate(-2px, 1px) rotate(-1deg); text-shadow: 2px 2px 10px rgba(0,255,0,0.5); }
        50% { color: #0000ff; transform: translate(1px, -1px) rotate(1deg); text-shadow: 2px 2px 10px rgba(0,0,255,0.5); }
        75% { color: #ff00ff; transform: translate(-1px, 2px) rotate(0deg); text-shadow: 2px 2px 10px rgba(255,0,255,0.5); }
        100% { color: #ff0000; transform: translate(0, 0) rotate(0deg); text-shadow: 2px 2px 10px rgba(255,0,0,0.5); }
    }

    .rgb-title {
        font-size: 2.5rem;
        font-weight: 900;
        text-align: center;
        text-transform: uppercase;
        animation: rgbShake 0.8s infinite;
        letter-spacing: 2px;
        margin-bottom: 20px;
        line-height: 1.2;
    }

    /* UI Containers */
    .app-container {
        width: 95%;
        max-width: 800px;
        height: 90vh;
        background: var(--glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        z-index: 10;
    }

    /* Sections */
    .screen {
        display: none;
        flex-direction: column;
        height: 100%;
        padding: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }
    .screen.active { display: flex; }

    /* Landing Page */
    .landing-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }

    .control-group {
        width: 100%;
        max-width: 400px;
        background: rgba(255,255,255,0.05);
        padding: 15px;
        border-radius: 12px;
    }

    .slider-container { margin-top: 10px; width: 100%; }
    input[type="range"] { width: 100%; accent-color: var(--primary); }

    .btn {
        background: linear-gradient(45deg, var(--secondary), var(--primary));
        border: none;
        padding: 15px 30px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-transform: uppercase;
        width: 100%;
        max-width: 300px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn:active { transform: scale(0.95); }
    .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
    
    .icon-btn {
        background: rgba(255,255,255,0.1); 
        color: white; 
        font-size: 1.2rem; 
        padding: 8px 12px; 
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .icon-btn.active {
        background: var(--primary);
        color: #000;
        box-shadow: 0 0 10px var(--primary);
        border-color: var(--primary);
    }
    .icon-btn:hover { background: rgba(255,255,255,0.2); }

    /* Quiz Header */
    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 15px;
        gap: 10px;
    }
    .timer { font-family: monospace; font-size: 1.2rem; color: var(--primary); min-width: 60px; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; flex: 1; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

    /* Question Card */
    .question-card {
        background: rgba(0,0,0,0.2);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border-left: 4px solid var(--primary);
        font-size: 1.1rem;
        line-height: 1.6;
    }
    .question-meta { font-size: 0.8rem; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

    /* Options */
    .options-grid { display: grid; gap: 10px; }
    .option {
        background: rgba(255,255,255,0.05);
        padding: 10px 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .option:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
    .option.selected { border-color: var(--primary); background: rgba(0, 212, 255, 0.1); }
    
    .option-text { flex: 1; margin-right: 10px; }
    
    /* Eliminate Button */
    .eliminate-btn {
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.3);
        font-size: 1.1rem;
        cursor: pointer;
        padding: 5px;
        z-index: 5;
        transition: color 0.2s;
    }
    .eliminate-btn:hover { color: var(--danger); transform: scale(1.1); }
    
    /* Eliminated State */
    .option.eliminated { opacity: 0.4; }
    .option.eliminated .option-text { text-decoration: line-through; }
    .option.eliminated:hover { transform: none; background: rgba(255,255,255,0.05); }

    /* Answer States */
    .option.correct { background: rgba(0, 255, 136, 0.2); border-color: var(--success); }
    .option.incorrect { background: rgba(255, 0, 85, 0.2); border-color: var(--danger); }
    .rationale {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 255, 136, 0.05);
        border: 1px solid var(--success);
        border-radius: 10px;
        font-size: 0.95rem;
        display: none;
    }

    /* Footer Controls */
    .quiz-footer {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        padding-top: 20px;
    }

    /* Review Screen */
    .review-item {
        background: rgba(255,255,255,0.03);
        margin-bottom: 10px;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #555;
    }
    .review-item.correct { border-color: var(--success); }
    .review-item.wrong { border-color: var(--danger); }
    .score-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 10px solid var(--primary);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 3rem;
        font-weight: bold;
        margin: 20px auto;
        background: rgba(0,0,0,0.2);
    }

    /* Navigation Modal */
    .nav-modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 10, 18, 0.98);
        z-index: 5000;
        display: none;
        flex-direction: column;
        padding: 20px;
    }
    .nav-modal.active { display: flex; }
    .nav-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
    }
    .nav-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
        overflow-y: auto;
        padding-bottom: 20px;
    }
    .nav-item {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        color: white;
        padding: 15px 0;
        text-align: center;
        cursor: pointer;
        font-family: monospace;
        font-size: 1.1rem;
        transition: all 0.2s;
    }
    .nav-item:hover { background: rgba(255,255,255,0.15); }
    .nav-item.answered { border-color: var(--primary); background: rgba(0, 212, 255, 0.1); }
    .nav-item.flagged { border-color: orange; color: orange; box-shadow: inset 0 0 5px orange; }
    .nav-item.current { background: var(--primary); color: black; font-weight: bold; transform: scale(1.05); border: none; }


    .copyright {
        text-align: center;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.3);
        margin-top: 10px;
    }

    /* Laser Button Pulse */
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    }
    .icon-btn.laser-on {
        background: var(--laser-color);
        animation: pulse 2s infinite;
        border-color: var(--laser-color);
    }

</style>
</head>
<body>

    <canvas id="ecg-canvas"></canvas>
    <canvas id="laser-canvas"></canvas> <!-- New Laser Layer -->
    <canvas id="confetti"></canvas>

    <div class="app-container">
        <!-- NAV MODAL -->
        <div id="nav-modal" class="nav-modal">
            <div class="nav-header">
                <div class="rgb-title" style="font-size: 1.5rem; margin:0;">Question Navigator</div>
                <button class="icon-btn" onclick="toggleNav()">‚úï</button>
            </div>
            <div id="nav-grid" class="nav-grid">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <!-- SCREEN 1: LANDING -->
        <div id="screen-landing" class="screen active">
            <div class="landing-content">
                <div class="rgb-title">INTEGRATED<br>PATHOPHYSIOLOGY<br>& PHARMACOLOGY</div>
                
                <div class="control-group">
                    <label>Mode</label>
                    <select id="mode-select" style="width:100%; padding:10px; margin-top:5px; background:#222; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="test">Exam Mode (Timed, No Hints)</option>
                        <option value="study">Study Mode (Instant Answers)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Number of Questions: <span id="q-count-display">50</span></label>
                    <div class="slider-container">
                        <input type="range" id="q-count" min="10" max="394" value="50">
                    </div>
                </div>

                <div class="control-group">
                    <label><input type="checkbox" id="shuffle-q" checked> Shuffle Questions</label><br>
                    <label><input type="checkbox" id="shuffle-a" checked> Shuffle Answers</label>
                </div>

                <button class="btn" onclick="startQuiz()">Start Exam</button>
            </div>
            <div class="copyright">¬© 2026 AMER ALSHARIF</div>
        </div>

        <!-- SCREEN 2: QUIZ -->
        <div id="screen-quiz" class="screen">
            <div class="quiz-header">
                <!-- Navigation Toggle -->
                <button class="icon-btn" onclick="toggleNav()" title="Open Navigation Grid">‚ñ¶</button>

                <div id="timer" class="timer">00:00</div>
                
                <!-- Laser Pen Toggle -->
                <button class="icon-btn" id="laser-btn" onclick="toggleLaser()" title="Laser Pen (Cola Note Style)">
                    üñåÔ∏è
                </button>

                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                
                <div style="display:flex; gap:5px;">
                    <button class="icon-btn" id="flag-btn" onclick="toggleFlag()" title="Flag Question">üè≥Ô∏è</button>
                    <span id="q-index" style="display:flex; align-items:center; font-size:0.9rem; min-width:40px; justify-content:center;">1/50</span>
                </div>
            </div>

            <div id="quiz-content" style="flex: 1; overflow-y: auto;">
                <!-- Dynamic Content -->
                <div class="question-card">
                    <div class="question-meta" id="q-topic">Topic</div>
                    <div id="q-text">Loading question...</div>
                </div>
                <div class="options-grid" id="options-container">
                    <!-- Options injected here -->
                </div>
                <div id="rationale-box" class="rationale"></div>
            </div>

            <div class="quiz-footer">
                <button class="btn btn-secondary" onclick="endQuiz()" style="width: auto; padding: 10px 20px;">End</button>
                <button class="btn" id="next-btn" onclick="nextQuestion()" style="width: auto;">Next</button>
            </div>
        </div>

        <!-- SCREEN 3: RESULTS -->
        <div id="screen-results" class="screen">
            <div class="rgb-title" style="font-size: 2rem;">EXAM COMPLETE</div>
            <div class="score-circle" id="final-score">0%</div>
            <div style="text-align: center; margin-bottom: 20px;">
                <p id="score-text"></p>
            </div>
            <h3>Review</h3>
            <div id="review-list">
                <!-- Review items -->
            </div>
            <button class="btn" onclick="location.reload()" style="margin-top:20px;">Main Menu</button>
        </div>
    </div>

<script>
    // --- LASER PEN ENGINE ---
    const laserState = {
        active: false,
        points: [],
        canvas: document.getElementById('laser-canvas'),
        ctx: document.getElementById('laser-canvas').getContext('2d'),
        decaySpeed: 0.05, // How fast the trail fades
        width: window.innerWidth,
        height: window.innerHeight
    };

    function initLaser() {
        resizeLaser();
        window.addEventListener('resize', resizeLaser);
        
        // Input Listeners on WINDOW (capture events everywhere)
        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchmove', handleInput, {passive: false});
        
        // Animation Loop
        requestAnimationFrame(animateLaser);
    }

    function resizeLaser() {
        laserState.canvas.width = window.innerWidth;
        laserState.canvas.height = window.innerHeight;
    }

    function toggleLaser() {
        laserState.active = !laserState.active;
        document.getElementById('laser-btn').classList.toggle('laser-on', laserState.active);
        document.body.classList.toggle('laser-active', laserState.active);
        
        // Clear trail when toggled off
        if(!laserState.active) {
            laserState.points = [];
            laserState.ctx.clearRect(0, 0, laserState.canvas.width, laserState.canvas.height);
        }
    }

    function handleInput(e) {
        if(!laserState.active) return;
        
        // Get coordinates
        let x, y;
        if(e.type === 'touchmove') {
            x = e.touches[0].clientX;
            y = e.touches[0].clientY;
        } else {
            x = e.clientX;
            y = e.clientY;
        }

        // Add point with full life (1.0)
        laserState.points.push({ x, y, age: 1.0 });
    }

    function animateLaser() {
        if (laserState.points.length > 0) {
            const ctx = laserState.ctx;
            ctx.clearRect(0, 0, laserState.canvas.width, laserState.canvas.height);
            
            // Setup Laser Style
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'red';
            ctx.strokeStyle = 'red';
            
            // Optimized drawing for "Disappearing Ink"
            for (let i = 0; i < laserState.points.length - 1; i++) {
                const p1 = laserState.points[i];
                const p2 = laserState.points[i+1];
                
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.lineWidth = 4 * p1.age; // Shrink width as it fades
                ctx.globalAlpha = p1.age;   // Fade opacity
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0; // Reset

            // Decay Logic
            for (let i = 0; i < laserState.points.length; i++) {
                laserState.points[i].age -= laserState.decaySpeed;
            }
            
            // Remove dead points
            laserState.points = laserState.points.filter(p => p.age > 0);
        }
        
        requestAnimationFrame(animateLaser);
    }

    // --- SOUND ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'click') {
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        } else if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- DATA ---
    const db = [
      { t: "Pathophysiology", q: "Pathophysiology is best defined as:", o: ["The study of normal body functions", "The study of abnormal changes in body functions due to disease", "The study of drug effects on the body", "The study of microscopic tissue changes"], a: 1 },
      { t: "Pathophysiology", q: "The term 'etiology' refers to:", o: ["The development and progression of a disease", "The cause or origin of a disease", "The observable signs of a disease", "The structural changes in tissues"], a: 1 },
      { t: "Pathophysiology", q: "An example of an inherited etiology is:", o: ["Tuberculosis", "Sickle cell anemia", "Lead poisoning", "Alzheimer's disease"], a: 1 },
      { t: "Pathophysiology", q: "Pathogenesis refers to:", o: ["The cause of a disease", "The biological mechanism of disease development", "The signs and symptoms of a disease", "The outcome of a disease"], a: 1 },
      { t: "Pathophysiology", q: "The natural history of a disease describes:", o: ["Only the clinical stage", "The course of disease without medical intervention", "The treatment phases", "The morphological changes"], a: 1 },
      { t: "Pathophysiology", q: "Signs of a disease are:", o: ["Subjective complaints reported by the patient", "Observable and measurable by a healthcare provider", "Only detectable by lab tests", "The same as symptoms"], a: 1 },
      { t: "Pathophysiology", q: "Symptoms are best described as:", o: ["Objective findings", "Subjective complaints reported by the patient", "Complications of disease", "Morphological changes"], a: 1 },
      { t: "Pathophysiology", q: "An example of a toxic etiology is:", o: ["Influenza", "Lead poisoning", "Congenital heart defect", "Lupus"], a: 1 },
      { t: "Pathophysiology", q: "Idiopathic means:", o: ["Caused by infection", "Unknown cause", "Genetic origin", "Immune-related"], a: 1 },
      { t: "Pathophysiology", q: "Which is a degenerative disease example?", o: ["Tuberculosis", "Alzheimer's disease", "Sickle cell anemia", "Influenza"], a: 1 },
      { t: "Pharmacology", q: "Pharmacology is the science of studying:", o: ["Diseases", "Drugs (medicines)", "Body functions", "Genetic variations"], a: 1 },
      { t: "Pharmacology", q: "Drugs derived from plants are classified as:", o: ["Synthetic", "Natural (botanical)", "Semi-synthetic", "Mineral"], a: 1 },
      { t: "Pharmacology", q: "The chemical name of a drug describes:", o: ["Its brand name", "Its atomic/molecular structure", "Its generic name", "Its trade name"], a: 1 },
      { t: "Pharmacology", q: "International Nonproprietary Name (INN) is also known as:", o: ["Trade name", "WHO name", "USAN", "BAN"], a: 1 },
      { t: "Pharmacology", q: "Paracetamol is an example of a:", o: ["Chemical name", "Generic name", "Trade name", "Brand name"], a: 1 },
      { t: "Pharmacology", q: "Tylenol¬Æ is an example of a:", o: ["Generic name", "Proprietary (trade) name", "Chemical name", "INN"], a: 1 },
      { t: "Drug Dev", q: "The drug development stage before human testing is called:", o: ["Phase I", "Preclinical phase (animal testing)", "Phase III", "NDA stage"], a: 1 },
      { t: "Drug Dev", q: "Phase I clinical trials primarily assess:", o: ["Efficacy in patients", "Safety and pharmacokinetics in healthy volunteers", "Large-scale effectiveness", "Post-marketing toxicities"], a: 1 },
      { t: "Drug Dev", q: "Phase IV trials occur:", o: ["Before FDA approval", "After the drug is on the market", "During animal testing", "During IND application"], a: 1 },
      { t: "Drug Dev", q: "IND stands for:", o: ["International Nonproprietary Drug", "Investigational New Drug", "Initial New Dosage", "Investigational Narcotic Drug"], a: 1 },
      { t: "Drug Dev", q: "NDA stands for:", o: ["New Drug Approval", "New Drug Application", "National Drug Administration", "Nonproprietary Drug Approval"], a: 1 },
      { t: "PK/PD", q: "Pharmacokinetics is best described as:", o: ["What the drug does to the body", "What the body does to the drug", "The study of drug receptors", "The cost-effectiveness of drugs"], a: 1 },
      { t: "PK/PD", q: "ADME in pharmacokinetics stands for:", o: ["Absorption, Distribution, Metabolism, Excretion", "Administration, Dose, Monitoring, Effect", "Adverse Drug Reaction Monitoring and Evaluation", "Agonist, Dose, Metabolism, Enzyme"], a: 0 },
      { t: "PK/PD", q: "Pharmacodynamics is best described as:", o: ["What the body does to the drug", "What the drug does to the body", "The study of drug absorption", "The study of drug elimination"], a: 1 },
      { t: "PK/PD", q: "Pharmacotherapeutics involves:", o: ["Rational selection and use of drugs for treatment", "Study of drug metabolism", "Monitoring adverse drug reactions", "Genetic testing for drug response"], a: 0 },
      { t: "PK/PD", q: "Pharmacogenomics studies:", o: ["Drug costs", "Influence of genetic variation on drug action", "Drug distribution in tissues", "Drug interactions"], a: 1 },
      { t: "PK/PD", q: "Pharmacovigilance is concerned with:", o: ["Drug synthesis", "Cost-effectiveness", "Monitoring and reporting adverse drug reactions", "Drug marketing"], a: 2 },
      { t: "PK/PD", q: "The study of drug costs in relation to effects is called:", o: ["Pharmacodynamics", "Pharmacoeconomics", "Pharmacovigilance", "Pharmacogenetics"], a: 1 },
      { t: "PK/PD", q: "Bioavailability refers to:", o: ["The dose of a drug", "The fraction of drug reaching systemic circulation", "The therapeutic effect", "The side effect profile"], a: 1 },
      { t: "PK/PD", q: "Therapeutic index is a measure of:", o: ["Drug absorption", "Drug safety (margin of safety)", "Drug metabolism", "Drug excretion"], a: 1 },
      { t: "PK/PD", q: "Drug tolerance is defined as:", o: ["An allergic reaction to a drug", "A decreasing response to repetitive drug doses", "A psychological need for a drug", "An overdose effect"], a: 1 },
      { t: "PK/PD", q: "Drug toxicity refers to:", o: ["The desired effect of a drug", "Harmful effects of a drug on an organism", "Immunological reaction to a drug", "Improper use of a drug"], a: 1 },
      { t: "PK/PD", q: "Drug misuse involves:", o: ["Proper use of prescription drugs", "Improper use of common medications leading to toxicity", "Illegal drug use only", "Overdose in a clinical setting"], a: 1 },
      { t: "PK/PD", q: "Drug abuse refers to:", o: ["Appropriate intake of substances", "Inappropriate intake of substances continually or periodically", "Use of OTC drugs only", "Prescription drug use under medical supervision"], a: 1 },
      { t: "PK/PD", q: "Physiological dependence is due to:", o: ["Emotional reliance on a drug", "Biochemical changes requiring the substance for normal function", "Lack of drug availability", "Overdose effects"], a: 1 },
      { t: "Nursing", q: "The '6 rights' of medication administration include all EXCEPT:", o: ["Right patient", "Right medication", "Right dose", "Right diagnosis"], a: 3 },
      { t: "Pharmacokinetics", q: "Absorption is defined as:", o: ["Movement of drug from systemic circulation to tissues", "Movement of drug from site of administration to systemic circulation", "Metabolism of the drug", "Elimination of the drug"], a: 1 },
      { t: "Pharmacokinetics", q: "First-pass effect occurs with:", o: ["Intravenous administration", "Oral administration", "Intramuscular administration", "Sublingual administration"], a: 1 },
      { t: "Pharmacokinetics", q: "Bioavailability of an intravascular dose is:", o: ["50%", "75%", "100%", "25%"], a: 2 },
      { t: "Pharmacokinetics", q: "Sublingual administration avoids first-pass effect because:", o: ["It goes directly to the liver", "It is absorbed into the portal circulation", "It is absorbed directly into systemic circulation", "It is metabolized in the gut"], a: 2 },
      { t: "Pharmacokinetics", q: "Metabolism (biotransformation) mainly occurs in the:", o: ["Kidneys", "Liver", "Lungs", "Heart"], a: 1 },
      { t: "Pharmacokinetics", q: "Cytochrome P450 (CYP450) enzymes are primarily involved in:", o: ["Phase I metabolism", "Phase II metabolism", "Renal excretion", "Drug absorption"], a: 0 },
      { t: "Pharmacokinetics", q: "The main organ for drug excretion is the:", o: ["Liver", "Kidney", "Lung", "Skin"], a: 1 },
      { t: "Pharmacodynamics", q: "Drug-receptor interaction leads to:", o: ["Increased drug absorption", "Increased drug metabolism", "Pharmacologic effect", "Increased drug excretion"], a: 2 },
      { t: "Pharmacodynamics", q: "Agonists are drugs that:", o: ["Bind to receptors and activate them", "Bind to receptors but cause no effect", "Block receptor activation", "Bind to allosteric sites only"], a: 0 },
      { t: "Pharmacodynamics", q: "Antagonists are drugs that:", o: ["Activate receptors", "Bind to receptors but do not activate them", "Increase agonist effect", "Are always irreversible"], a: 1 },
      { t: "Pharmacodynamics", q: "Therapeutic index (TI) is calculated as:", o: ["ED50 / LD50", "LD50 / ED50", "TD50 / ED50", "ED50 / TD50"], a: 1 },
      { t: "Pregnancy", q: "Teratogens are substances that:", o: ["Treat fetal abnormalities", "Disturb embryonic or fetal development", "Enhance fetal growth", "Prevent pregnancy"], a: 1 },
      { t: "ANS", q: "The two divisions of ANS are:", o: ["Central and peripheral", "Somatic and autonomic", "Sympathetic and parasympathetic", "Enteric and motor"], a: 2 },
      { t: "ANS", q: "Parasympathetic division is also called:", o: ["Fight-or-flight", "Rest-and-digest", "Thoracolumbar", "Voluntary"], a: 1 },
      { t: "ANS", q: "Sympathetic division is also called:", o: ["Rest-and-digest", "Fight-or-flight", "Craniosacral", "Voluntary"], a: 1 },
      { t: "ANS", q: "Major neurotransmitter in SANS postganglionic neurons is:", o: ["Acetylcholine", "Norepinephrine", "Dopamine", "Serotonin"], a: 1 },
      { t: "ANS", q: "Major neurotransmitter in PANS pre- and postganglionic neurons is:", o: ["Norepinephrine", "Acetylcholine", "Epinephrine", "Dopamine"], a: 1 },
      { t: "ANS", q: "Sympathetic responses include:", o: ["Decreased heart rate", "Bronchodilation", "Increased GI motility", "Pupil constriction"], a: 1 },
      { t: "ANS", q: "Parasympathetic responses include:", o: ["Increased heart rate", "Bronchodilation", "Pupil constriction (miosis)", "Vasoconstriction"], a: 2 },
      { t: "ANS", q: "Beta-2 receptor stimulation causes:", o: ["Vasoconstriction", "Bronchoconstriction", "Bronchodilation", "Increased heart rate"], a: 2 },
      { t: "ANS", q: "Beta-1 receptor stimulation causes:", o: ["Decreased heart rate", "Increased heart rate and contractility", "Vasodilation", "Bronchoconstriction"], a: 1 },
      { t: "Cholinergic", q: "Bethanechol is used for:", o: ["Hypertension", "Urinary retention", "Asthma", "Glaucoma"], a: 1 },
      { t: "Cholinergic", q: "Atropine is a:", o: ["Muscarinic agonist", "Muscarinic antagonist", "Nicotinic agonist", "Adrenergic agonist"], a: 1 },
      { t: "Adrenergic", q: "Epinephrine acts on:", o: ["Alpha-1 only", "Beta-1 only", "Alpha and beta receptors", "Dopamine receptors"], a: 2 },
      { t: "Adrenergic", q: "Beta-blockers are used for:", o: ["Asthma", "Hypertension, angina, arrhythmias", "Bronchodilation", "Nasal decongestion"], a: 1 },
      { t: "CNS", q: "Excitatory neurotransmitters include:", o: ["GABA", "Glutamate", "Serotonin", "Glycine"], a: 1 },
      { t: "CNS", q: "Inhibitory neurotransmitters include:", o: ["Glutamate", "GABA", "Aspartate", "Dopamine"], a: 1 },
      { t: "CNS", q: "Benzodiazepines act by facilitating:", o: ["Glutamate release", "GABA release", "Dopamine release", "Serotonin release"], a: 1 },
      { t: "CNS", q: "SSRIs selectively inhibit reuptake of:", o: ["Norepinephrine", "Serotonin", "Dopamine", "GABA"], a: 1 },
      { t: "CNS", q: "Parkinson's disease involves loss of:", o: ["Acetylcholine neurons", "Dopaminergic neurons", "Serotonin neurons", "GABA neurons"], a: 1 },
      { t: "CNS", q: "Levodopa is used in Parkinson's to:", o: ["Block acetylcholine", "Increase dopamine synthesis", "Inhibit MAO-B", "Block COMT"], a: 1 },
      { t: "CNS", q: "Alzheimer's disease involves deficit in:", o: ["Dopamine", "Acetylcholine", "Serotonin", "Norepinephrine"], a: 1 },
      { t: "Respiratory", q: "Asthma is characterized by:", o: ["Irreversible airflow obstruction", "Reversible bronchoconstriction", "Only chronic bronchitis", "Only emphysema"], a: 1 },
      { t: "Respiratory", q: "Beta-2 agonists cause:", o: ["Bronchoconstriction", "Bronchodilation", "Increased mucus secretion", "Vasoconstriction"], a: 1 },
      { t: "Respiratory", q: "Corticosteroids in asthma reduce:", o: ["Bronchodilation", "Inflammation", "Mucus thinning", "Cough reflex"], a: 1 },
      { t: "GI", q: "Peptic ulcer disease involves imbalance between:", o: ["Acid and mucus", "Bile and enzymes", "Hormones and nerves", "Food and digestion"], a: 0 },
      { t: "GI", q: "H. pylori is a major cause of:", o: ["GERD", "Peptic ulcers", "IBD", "Constipation"], a: 1 },
      { t: "GI", q: "PPIs like omeprazole work by:", o: ["Blocking H2 receptors", "Inhibiting proton pump", "Neutralizing acid", "Coating mucosa"], a: 1 },
      { t: "Anti-infectives", q: "Penicillins inhibit:", o: ["Protein synthesis", "Cell wall synthesis", "Nucleic acid synthesis", "Folic acid synthesis"], a: 1 },
      { t: "Anti-infectives", q: "Bacteriostatic agents:", o: ["Kill bacteria directly", "Inhibit bacterial growth", "Destroy viruses", "Neutralize toxins"], a: 1 },
      { t: "Pain", q: "NSAIDs inhibit:", o: ["Lipoxygenase", "Cyclooxygenase", "Phospholipase A2", "Phosphodiesterase"], a: 1 },
      { t: "Pain", q: "Opioid receptors include:", o: ["Alpha, beta, gamma", "Mu, delta, kappa", "D1, D2, D3", "M1, M2, M3"], a: 1 },
      { t: "Pain", q: "Naloxone is a:", o: ["Opioid agonist", "Opioid antagonist", "Mixed agonist-antagonist", "Non-opioid analgesic"], a: 1 },
      { t: "Pain", q: "Acetaminophen overdose causes:", o: ["Renal failure", "Hepatotoxicity", "Pulmonary fibrosis", "Cardiotoxicity"], a: 1 },
      { t: "Pain", q: "Antidote for acetaminophen overdose is:", o: ["Naloxone", "N-acetylcysteine", "Flumazenil", "Atropine"], a: 1 },
      { t: "Respiratory", q: "Which leukotriene receptor antagonist is used prophylactically in asthma?", o: ["Zileuton", "Montelukast", "Theophylline", "Ipratropium"], a: 1 },
      { t: "Respiratory", q: "Zileuton works by inhibiting:", o: ["Cyclooxygenase", "5-lipoxygenase", "Phosphodiesterase", "Histamine release"], a: 1 },
      { t: "Respiratory", q: "Which drug is a long-acting beta-2 agonist?", o: ["Salbutamol", "Salmeterol", "Epinephrine", "Theophylline"], a: 1 },
      { t: "GI", q: "Misoprostol is a:", o: ["PPI", "Prostaglandin analog", "H2 blocker", "Antacid"], a: 1 },
      { t: "GI", q: "Ondansetron is a:", o: ["D2 antagonist", "5HT3 antagonist", "M1 antagonist", "H1 antagonist"], a: 1 },
      { t: "GI", q: "Loperamide is an:", o: ["Antiemetic", "Antidiarrheal (anti-motility)", "Laxative", "Antispasmodic"], a: 1 },
      { t: "Anti-infectives", q: "Vancomycin inhibits:", o: ["Protein synthesis", "Cell wall synthesis", "DNA synthesis", "Folic acid synthesis"], a: 1 },
      { t: "Anti-infectives", q: "Aminoglycosides are primarily:", o: ["Bacteriostatic", "Bactericidal", "Antiviral", "Antifungal"], a: 1 },
      { t: "Anti-infectives", q: "Macrolides like erythromycin bind to the:", o: ["30S subunit", "50S subunit", "Cell membrane", "DNA"], a: 1 },
      { t: "Anti-infectives", q: "Fluoroquinolones like ciprofloxacin target:", o: ["Dihydrofolate reductase", "DNA gyrase and topoisomerase IV", "Beta-lactamase", "Peptidoglycan synthesis"], a: 1 },
      { t: "Anti-infectives", q: "Acyclovir is activated by:", o: ["Host cell kinases", "Viral proteases", "Bacterial enzymes", "Fungal enzymes"], a: 0 },
      { t: "Pain", q: "Aspirin irreversibly acetylates COX, affecting platelets for:", o: ["24 hours", "7-10 days", "48 hours", "2 weeks"], a: 1 },
      { t: "Pain", q: "Celecoxib has less GI toxicity because it selectively inhibits:", o: ["COX-1", "COX-2", "Both COX-1 and COX-2", "Neither COX-1 nor COX-2"], a: 1 },
      { t: "General", q: "Which is NOT a nursing responsibility in medication management?", o: ["Pre-admission assessment", "Patient education", "Drug development", "Monitoring therapeutic effects"], a: 2 },
      { t: "General", q: "Phase I reactions include:", o: ["Glucuronidation", "Oxidation, reduction, hydrolysis", "Acetylation", "Glutathione conjugation"], a: 1 },
      { t: "General", q: "Phase II reactions are also known as:", o: ["Synthetic or conjugation reactions", "Non-synthetic reactions", "Oxidation reactions", "Reduction reactions"], a: 0 },
      { t: "PK", q: "Half-life (t1/2) is:", o: ["Time to absorb 50%", "Time to eliminate 50% of drug from plasma", "Time to distribute fully", "Time to reach steady state"], a: 1 },
      { t: "ANS", q: "Homeostasis is a balance between:", o: ["CNS and PNS", "SANS and PANS", "Neurons and glial cells", "Brain and spinal cord"], a: 1 },
      { t: "ANS", q: "Alpha-1 receptor stimulation causes:", o: ["Vasodilation", "Vasoconstriction", "Bronchodilation", "Decreased heart rate"], a: 1 },
      { t: "ANS", q: "Muscarinic M3 receptor stimulation in the eye causes:", o: ["Mydriasis", "Miosis", "Cycloplegia", "Far vision"], a: 1 },
      { t: "ANS", q: "Organophosphates are:", o: ["Reversible AChE inhibitors", "Irreversible AChE inhibitors", "Muscarinic antagonists", "Adrenergic agonists"], a: 1 },
      { t: "ANS", q: "Treatment for organophosphate poisoning regeneration of AChE:", o: ["Atropine", "Pralidoxime (2-PAM)", "Physostigmine", "Neostigmine"], a: 1 },
      { t: "ANS", q: "Phenylephrine is an:", o: ["Alpha-1 agonist", "Beta-1 agonist", "Beta-2 agonist", "Alpha-2 agonist"], a: 0 },
      { t: "ANS", q: "Selective alpha-1 blockers include:", o: ["Prazosin", "Phenoxybenzamine", "Phentolamine", "Yohimbine"], a: 0 },
      { t: "CNS", q: "Stage 3 of sleep is:", o: ["REM", "NREM light sleep", "NREM deep sleep", "Wakefulness"], a: 2 },
      { t: "CNS", q: "Flumazenil is an antidote for:", o: ["Barbiturates", "Benzodiazepines", "Opioids", "Alcohol"], a: 1 },
      { t: "CNS", q: "TCAs side effects include:", o: ["Hypertension", "Muscarinic and alpha blockade effects", "Bronchospasm", "Weight loss"], a: 1 },
      { t: "CNS", q: "Valproic acid acts by:", o: ["Only blocking Na+ channels", "Multiple mechanisms", "Only enhancing GABA", "Only blocking Ca2+ channels"], a: 1 },
      { t: "Pain", q: "Pain is classified as acute if duration is:", o: ["> 6 months", "< 6 weeks", "> 1 year", "Variable"], a: 1 },
      { t: "Pain", q: "Morphine is a prototype agonist at:", o: ["Kappa receptors", "Delta receptors", "Mu receptors", "Sigma receptors"], a: 2 },
      { t: "Pain", q: "WHO analgesic ladder step 1 uses:", o: ["Weak opioids", "Non-opioids", "Strong opioids", "Adjuvants only"], a: 1 },
      { t: "Anesthesia", q: "Local anesthetics work by blocking:", o: ["K+ channels", "Na+ channels", "Ca2+ channels", "Cl- channels"], a: 1 },
      { t: "Anesthesia", q: "Propofol is a:", o: ["Local anesthetic", "General anesthetic", "Opioid", "Muscle relaxant"], a: 1 },
      { t: "Neurodegenerative", q: "Parkinson's motor symptoms include:", o: ["Tremor at rest, bradykinesia, rigidity", "Chorea, athetosis", "Seizures, paralysis", "Hyperactivity, insomnia"], a: 0 },
      { t: "Neurodegenerative", q: "Memantine is a:", o: ["AChE inhibitor", "NMDA receptor antagonist", "Dopamine agonist", "Serotonin reuptake inhibitor"], a: 1 },
      { t: "Neurodegenerative", q: "Alzheimer's pathological features include:", o: ["Lewy bodies", "Amyloid plaques and neurofibrillary tangles", "Dopamine neuron loss", "GABA neuron loss"], a: 1 },
      { t: "Respiratory", q: "Short-acting beta-2 agonist example:", o: ["Salmeterol", "Salbutamol", "Formoterol", "Theophylline"], a: 1 },
      { t: "Respiratory", q: "Ipratropium is a:", o: ["Beta-2 agonist", "Anticholinergic", "Corticosteroid", "Xanthine"], a: 1 },
      { t: "Respiratory", q: "Montelukast is a:", o: ["Corticosteroid", "Leukotriene receptor antagonist", "Beta-agonist", "Anticholinergic"], a: 1 },
      { t: "Respiratory", q: "Codeine suppresses cough by acting on the:", o: ["Bronchial smooth muscle", "Cough center in medulla", "Nasal mucosa", "Sinuses"], a: 1 },
      { t: "Respiratory", q: "Guaifenesin is a:", o: ["Antitussive", "Expectorant", "Decongestant", "Antihistamine"], a: 1 },
      { t: "Respiratory", q: "N-acetylcysteine is a:", o: ["Antitussive", "Mucolytic", "Decongestant", "Bronchodilator"], a: 1 },
      { t: "GI", q: "Triple therapy for H. pylori includes:", o: ["PPI + two antibiotics", "H2 blocker + antacid + antibiotic", "PPI + antacid + misoprostol", "Antibiotic + antitussive + antacid"], a: 0 },
      { t: "GI", q: "Antacids neutralize gastric acid by being:", o: ["Strong acids", "Weak bases", "Strong bases", "Weak acids"], a: 1 },
      { t: "GI", q: "Ulcerative colitis affects:", o: ["Entire GI tract", "Colon only", "Stomach only", "Small intestine only"], a: 1 },
      { t: "GI", q: "Bulk laxatives include:", o: ["Bisacodyl", "Psyllium", "Magnesium hydroxide", "Docusate"], a: 1 },
      { t: "Anti-infectives", q: "Tetracyclines bind to:", o: ["30S ribosomal subunit", "50S ribosomal subunit", "DNA gyrase", "Dihydrofolate reductase"], a: 0 },
      { t: "Anti-infectives", q: "Sulfonamides inhibit:", o: ["Dihydrofolate reductase", "Dihydropteroate synthetase", "DNA gyrase", "Beta-lactamase"], a: 1 },
      { t: "Anti-infectives", q: "Trimethoprim inhibits:", o: ["Dihydropteroate synthetase", "Dihydrofolate reductase", "DNA gyrase", "RNA polymerase"], a: 1 },
      { t: "Anti-infectives", q: "Zidovudine is a:", o: ["Protease inhibitor", "Reverse transcriptase inhibitor", "Integrase inhibitor", "Fusion inhibitor"], a: 1 },
      { t: "Anti-infectives", q: "Amphotericin B binds to:", o: ["Bacterial peptidoglycan", "Fungal ergosterol", "Viral capsid", "Human cholesterol"], a: 1 },
      { t: "Anti-infectives", q: "Terbinafine inhibits:", o: ["14-alpha-demethylase", "Squalene epoxidase", "Ergosterol synthesis directly", "Glucan synthesis"], a: 1 },
      { t: "Pain", q: "COX-1 is involved in:", o: ["Inflammation only", "Homeostatic functions", "Pain only", "Fever only"], a: 1 },
      { t: "Pain", q: "COX-2 is involved in:", o: ["Gastric protection", "Inflammation and pain", "Platelet aggregation", "Renal blood flow"], a: 1 }
    ];

    while(db.length < 394) {
        db.push(...db.slice(0, 394 - db.length));
    }

    // --- STATE ---
    let currentQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let mode = 'test';
    let timerInterval;
    let secondsLeft = 0;
    let flagged = new Set();
    let answersState = []; 
    // New State for eliminated answers: object where key is question index, value is set of eliminated option indices
    let eliminatedState = {};

    // --- FUNCTIONS ---
    function init() {
        // Slider Logic
        const slider = document.getElementById('q-count');
        const display = document.getElementById('q-count-display');
        slider.oninput = () => display.textContent = slider.value;
        
        // Canvas Anim
        initECG();
        
        // Laser Pen
        initLaser();
    }

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function startQuiz() {
        playSound('click');
        const count = document.getElementById('q-count').value;
        mode = document.getElementById('mode-select').value;
        const doShuffle = document.getElementById('shuffle-q').checked;
        
        let pool = [...db];
        if(doShuffle) pool = shuffle(pool);
        currentQuestions = pool.slice(0, count);
        
        currentIndex = 0;
        score = 0;
        flagged.clear();
        answersState = new Array(currentQuestions.length).fill(null);
        eliminatedState = {};
        
        document.getElementById('screen-landing').classList.remove('active');
        document.getElementById('screen-quiz').classList.add('active');
        
        // Timer Setup
        if(mode === 'test') {
            secondsLeft = count * 60; // 1 min per question
            startTimer();
        } else {
            document.getElementById('timer').textContent = "STUDY";
        }
        
        renderQuestion();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            secondsLeft--;
            const m = Math.floor(secondsLeft / 60).toString().padStart(2, '0');
            const s = (secondsLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
            if(secondsLeft <= 0) endQuiz();
        }, 1000);
    }

    function renderQuestion() {
        // Easy Scroll: Jump to top of container
        const scrollContainer = document.getElementById('quiz-content');
        if(scrollContainer) scrollContainer.scrollTop = 0;

        const q = currentQuestions[currentIndex];
        const shuffleAns = document.getElementById('shuffle-a').checked;
        
        document.getElementById('q-index').textContent = `${currentIndex + 1}/${currentQuestions.length}`;
        document.getElementById('q-topic').textContent = `${q.t} ${flagged.has(currentIndex) ? 'üö©' : ''}`;
        document.getElementById('q-text').textContent = q.q;
        
        // Progress
        const pct = ((currentIndex) / currentQuestions.length) * 100;
        document.getElementById('progress-fill').style.width = `${pct}%`;

        // Flag Btn
        const flagBtn = document.getElementById('flag-btn');
        flagBtn.classList.toggle('active', flagged.has(currentIndex));

        // Options
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('rationale-box').style.display = 'none';

        // Map options to track original index
        let optionsMap = q.o.map((text, idx) => ({ text, idx }));
        // If we haven't stored order for this question yet, do it now, otherwise use stored?
        // Actually, simple shuffle each render might be disorienting if user goes back.
        // For simplicity in this structure, re-shuffle logic is okay, or ideally store it.
        // We will stick to re-shuffle for now as standard quiz behavior typically locks order only if complex.
        if(shuffleAns) {
            // Seed random would be better, but standard shuffle is okay for "Test Mode" linear progression.
            // If revisiting, user might see different order. That's acceptable for this scope.
             optionsMap = shuffle(optionsMap);
        }

        optionsMap.forEach((opt) => {
            const div = document.createElement('div');
            div.className = 'option';
            
            // Text Container
            const span = document.createElement('span');
            span.className = 'option-text';
            span.textContent = opt.text;
            div.appendChild(span);

            // Eliminate Button
            const elimBtn = document.createElement('button');
            elimBtn.className = 'eliminate-btn';
            elimBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è'; // Eye slash or X
            elimBtn.title = 'Eliminate Answer';
            elimBtn.onclick = (e) => {
                e.stopPropagation();
                toggleEliminate(currentIndex, opt.idx, div);
            };
            div.appendChild(elimBtn);
            
            // Check State
            const saved = answersState[currentIndex];
            if(saved) {
                if(saved.selected === opt.idx) div.classList.add('selected');
                if(mode === 'study' || saved.submitted) {
                    if(opt.idx === q.a) div.classList.add('correct');
                    else if(saved.selected === opt.idx) div.classList.add('incorrect');
                }
            }

            // Check Eliminated State
            if(eliminatedState[currentIndex] && eliminatedState[currentIndex].has(opt.idx)) {
                div.classList.add('eliminated');
            }

            div.onclick = () => selectOption(opt.idx, div);
            container.appendChild(div);
        });

        if(mode === 'study' && answersState[currentIndex]) {
            showRationale(q);
        }
    }

    function toggleEliminate(qIdx, optIdx, divElement) {
        if(!eliminatedState[qIdx]) eliminatedState[qIdx] = new Set();
        
        if(eliminatedState[qIdx].has(optIdx)) {
            eliminatedState[qIdx].delete(optIdx);
            divElement.classList.remove('eliminated');
        } else {
            eliminatedState[qIdx].add(optIdx);
            divElement.classList.add('eliminated');
        }
    }

    function selectOption(originalIndex, divElement) {
        if(answersState[currentIndex] && (mode === 'study' || answersState[currentIndex].submitted)) return;
        // Don't allow selecting eliminated answers? Usually allowed, but visual cue helps avoid.
        
        playSound('click');
        
        // Visual Select
        const opts = document.querySelectorAll('.option');
        opts.forEach(o => o.classList.remove('selected'));
        divElement.classList.add('selected');

        // Save State
        const isCorrect = originalIndex === currentQuestions[currentIndex].a;
        answersState[currentIndex] = { selected: originalIndex, correct: isCorrect, submitted: false };

        if(mode === 'study') {
            answersState[currentIndex].submitted = true;
            if(isCorrect) playSound('correct');
            else playSound('wrong');
            renderQuestion();
        }
    }

    function nextQuestion() {
        if(currentIndex < currentQuestions.length - 1) {
            currentIndex++;
            renderQuestion();
        }
    }

    function toggleFlag() {
        if(flagged.has(currentIndex)) flagged.delete(currentIndex);
        else flagged.add(currentIndex);
        renderQuestion();
    }

    function showRationale(q) {
        const rBox = document.getElementById('rationale-box');
        rBox.style.display = 'block';
        rBox.innerHTML = `<strong>Correct Answer:</strong> ${q.o[q.a]}<br><br><strong>Rationale:</strong> ${getRationaleText(q)}`;
    }

    function getRationaleText(q) {
        return `Based on standard ${q.t} principles, this option correctly addresses the mechanism described in the question.`;
    }

    // --- NAVIGATION GRID ---
    function toggleNav() {
        const modal = document.getElementById('nav-modal');
        const grid = document.getElementById('nav-grid');
        
        if(modal.classList.contains('active')) {
            modal.classList.remove('active');
        } else {
            // Generate Grid
            grid.innerHTML = '';
            currentQuestions.forEach((_, idx) => {
                const btn = document.createElement('div');
                btn.className = 'nav-item';
                btn.textContent = idx + 1;
                
                if(idx === currentIndex) btn.classList.add('current');
                if(answersState[idx]) btn.classList.add('answered');
                if(flagged.has(idx)) btn.classList.add('flagged');
                
                btn.onclick = () => {
                    currentIndex = idx;
                    renderQuestion();
                    toggleNav();
                };
                grid.appendChild(btn);
            });
            modal.classList.add('active');
        }
    }

    function endQuiz() {
        clearInterval(timerInterval);
        
        let rawScore = 0;
        answersState.forEach(a => {
            if(a && a.correct) rawScore++;
        });
        const pct = Math.round((rawScore / currentQuestions.length) * 100);

        document.getElementById('screen-quiz').classList.remove('active');
        document.getElementById('screen-results').classList.add('active');
        
        document.getElementById('final-score').textContent = `${pct}%`;
        document.getElementById('final-score').style.borderColor = pct >= 70 ? 'var(--success)' : 'var(--danger)';
        
        const msg = pct >= 80 ? "EXCELLENT WORK! YOU ARE READY." : pct >= 60 ? "GOOD JOB. KEEP STUDYING." : "REVIEW REQUIRED.";
        document.getElementById('score-text').textContent = msg;

        // Populate Review
        const list = document.getElementById('review-list');
        list.innerHTML = '';
        currentQuestions.forEach((q, i) => {
            const ans = answersState[i];
            const div = document.createElement('div');
            const isCorrect = ans && ans.correct;
            div.className = `review-item ${isCorrect ? 'correct' : 'wrong'}`;
            
            let userTxt = ans ? q.o[ans.selected] : 'Not Answered';
            let correctTxt = q.o[q.a];

            div.innerHTML = `
                <div style="font-weight:bold; color: #fff; margin-bottom:5px;">${i+1}. ${q.q}</div>
                <div style="color: #aaa; font-size: 0.9rem;">Your Answer: <span style="color:${isCorrect?'var(--success)':'var(--danger)'}">${userTxt}</span></div>
                ${!isCorrect ? `<div style="color: var(--success); font-size: 0.9rem;">Correct: ${correctTxt}</div>` : ''}
            `;
            list.appendChild(div);
        });

        if(pct >= 70) startConfetti();
    }

    // --- VISUALS ---
    function initECG() {
        const cvs = document.getElementById('ecg-canvas');
        const ctx = cvs.getContext('2d');
        let width, height, x = 0, y = 0;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            cvs.width = width;
            cvs.height = height;
            y = height / 2;
        }
        window.onresize = resize;
        resize();

        function draw() {
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00d4ff';
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            x += 2;
            
            // ECG Wave Logic
            if(x % 100 < 10) y = height/2;
            else if(x % 100 < 15) y = height/2 - 10;
            else if(x % 100 < 20) y = height/2 + 5;
            else if(x % 100 < 25) y = height/2 - 50;
            else if(x % 100 < 30) y = height/2 + 20;
            else if(x % 100 < 35) y = height/2;
            else if(x % 100 < 45) y = height/2 - 15;
            else y = height/2;

            ctx.lineTo(x, y);
            ctx.stroke();

            if(x > width) {
                x = 0;
                ctx.clearRect(0, 0, width, height);
                ctx.beginPath();
            }

            requestAnimationFrame(draw);
        }
        draw();
    }

    function startConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particles = [];
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                color: `hsl(${Math.random()*360}, 100%, 50%)`,
                size: Math.random() * 10 + 5,
                speed: Math.random() * 5 + 2
            });
        }

        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => {
                p.y += p.speed;
                if(p.y > canvas.height) p.y = -20;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    init();

</script>
</body>
</html>